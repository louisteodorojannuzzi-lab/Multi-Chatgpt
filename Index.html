<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate Multi-ChatGPT Demo</title>

<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/0/04/ChatGPT_logo.svg"/>

<style>
:root {--bg:#0f1724;--panel:#0b1220;--accent:#7dd3fc;--text:#e6eef8;}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
body{background:linear-gradient(180deg,#071027 0%,#071c2e 100%);color:var(--text);display:flex;align-items:center;justify-content:center;}
.app{width:100%;max-width:900px;height:90vh;background:var(--panel);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,.6);display:flex;flex-direction:column;gap:12px;position:relative;}
header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
header h1{font-size:18px;margin:0;}
#messages{flex:1;overflow:auto;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;flex-direction:column;gap:8px;}
.msg{max-width:86%;padding:8px 12px;border-radius:8px;line-height:1.4;white-space:pre-wrap;position:relative;}
.me{align-self:flex-end;background:rgba(125,211,252,0.12);border:1px solid rgba(125,211,252,0.08);}
.bot{align-self:flex-start;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);}
.copy-btn{position:absolute;top:4px;right:4px;background:#7dd3fc;color:#002633;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:12px;}
form{display:flex;gap:8px;}
textarea{flex:1;min-height:44px;max-height:140px;resize:none;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);}
button{background:var(--accent);border:none;padding:10px 14px;border-radius:8px;color:#002633;cursor:pointer;font-weight:600;}
small.note{color:#9fb6c9;}
input#numChats{width:50px;margin-left:5px;}
#chatOrder{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0;}
.card{background:#1c2430;padding:6px 10px;border-radius:6px;cursor:grab;user-select:none;}
.card input{background:transparent;border:none;color:var(--text);width:100px;}
.card.locked{opacity:0.5;cursor:not-allowed;}
footer{position:absolute;bottom:5px;width:100%;text-align:center;font-size:12px;color:#9fb6c9;}
</style>
</head>
<body>
<div class="app">
<header>
  <h1>Ultimate Multi-ChatGPT Demo ✨</h1>
  <div style="margin-left:auto">
    <small class="note">Chats:</small>
    <input id="numChats" type="number" value="2" min="1" max="10"/>
    <label style="margin-left:10px;"><input type="checkbox" id="interBot" checked> AI Interact</label><br/>
    <input type="password" id="apiKey" placeholder="OpenAI Key"/>
    <button id="setKeyBtn">Set Key</button>
    <button id="vanishKeyBtn">Vanish Key</button>
    <button id="unvanishKeyBtn">Unvanish Key</button>
    <input type="text" id="webhookURL" placeholder="Webhook URL"/>
    <button id="toggleWebhookBtn">Enable Webhook</button>
  </div>
</header>

<div>
  <strong>Chat Order (factorial control!):</strong>
  <div id="chatOrder"></div>
</div>

<div id="messages" aria-live="polite"></div>

<form id="chatForm">
  <textarea id="input" placeholder="Type your message..." required></textarea>
  <button type="submit">Send</button>
</form>

<hr/>
<div>
  <input type="text" id="imagePrompt" placeholder="Image prompt"/>
  <button id="genImageBtn">Generate Image</button>
  <div id="imageContainer"></div>
</div>

<footer>
  Special thanks to ChatGPT for powering this AI interface! ❤️
</footer>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const messagesEl=document.getElementById('messages');
  const form=document.getElementById('chatForm');
  const input=document.getElementById('input');
  const numChatsInput=document.getElementById('numChats');
  const interBotCheckbox=document.getElementById('interBot');
  const apiKeyInput=document.getElementById('apiKey');
  const setKeyBtn=document.getElementById('setKeyBtn');
  const vanishKeyBtn=document.getElementById('vanishKeyBtn');
  const unvanishKeyBtn=document.getElementById('unvanishKeyBtn');
  const webhookURLInput=document.getElementById('webhookURL');
  const toggleWebhookBtn=document.getElementById('toggleWebhookBtn');
  const genImageBtn=document.getElementById('genImageBtn');
  const imagePromptInput=document.getElementById('imagePrompt');
  const imageContainer=document.getElementById('imageContainer');
  const chatOrderEl=document.getElementById('chatOrder');

  let webhookEnabled=false;
  let chatOrder=['User'];

  function createChats(){
    const count=parseInt(numChatsInput.value)||1;
    const chats=[];
    for(let i=1;i<=count;i++) chats.push({name:'ChatGPT '+i});
    return chats;
  }

  function renderChatOrder(){
    chatOrderEl.innerHTML='';
    chatOrder.forEach((name,index)=>{
      const card=document.createElement('div');
      card.className='card '+(name==='User'?'locked':'');
      const inputEl=document.createElement('input');
      inputEl.value=name;
      inputEl.disabled=name==='User';
      inputEl.addEventListener('input',()=>{chatOrder[index]=inputEl.value;renderChatOrder();});
      card.appendChild(inputEl);
      chatOrderEl.appendChild(card);
      card.draggable=true;
      card.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',index));
      card.addEventListener('dragover',e=>e.preventDefault());
      card.addEventListener('drop',e=>{
        e.preventDefault();
        const from=+e.dataTransfer.getData('text/plain');
        const to=index;
        if(chatOrder[to]==='User') return;
        [chatOrder[from],chatOrder[to]]=[chatOrder[to],chatOrder[from]];
        renderChatOrder();
      });
    });
  }
  renderChatOrder();

  function addMessage(text,who){
    const el=document.createElement('div');
    el.className='msg '+(who==='me'?'me':'bot');
    el.textContent=text;

    // Add copy button if it looks like code (contains common code symbols)
    if(who!=='me' && /[{}();=<>]/.test(text)){
      const copyBtn=document.createElement('button');
      copyBtn.textContent='Copy';
      copyBtn.className='copy-btn';
      copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(text);alert('Copied!');});
      el.appendChild(copyBtn);
    }

    messagesEl.appendChild(el);
    messagesEl.scrollTop=messagesEl.scrollHeight;
  }

  async function sendMessageInOrder(userText){
    addMessage(userText,'me');
    const chats=createChats();
    const allowInterBot=interBotCheckbox.checked;

    const fullOrder=chatOrder.slice();
    while(fullOrder.length<chats.length+1) fullOrder.push('ChatGPT '+fullOrder.length);

    for(let name of fullOrder){
      if(name==='User') continue;
      const el=document.createElement('div');
      el.className='msg bot';
      el.textContent=name+': ...typing';
      messagesEl.appendChild(el);
      messagesEl.scrollTop=messagesEl.scrollHeight;

      try{
        const res=await fetch('/api/chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({message:userText,chatName:name,allowInterBot})
        });
        const data=await res.json();
        el.textContent=name+': '+data.reply;

        // Copy button for code messages
        if(/[{}();=<>]/.test(data.reply)){
          const copyBtn=document.createElement('button');
          copyBtn.textContent='Copy';
          copyBtn.className='copy-btn';
          copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(data.reply);alert('Copied!');});
          el.appendChild(copyBtn);
        }

        messagesEl.scrollTop=messagesEl.scrollHeight;
      }catch(err){el.textContent=name+': Error: '+err.message;}
    }
  }

  form.addEventListener('submit',e=>{
    e.preventDefault();
    const t=input.value.trim();
    if(!t) return;
    input.value='';
    sendMessageInOrder(t);
  });

  // Enter / Shift+Enter behavior (Shift+Enter = newline)
  input.addEventListener('keydown', e => {
    if(e.key==='Enter'){
      if(e.shiftKey){
        e.preventDefault();
        const start=input.selectionStart;
        const end=input.selectionEnd;
        input.value=input.value.slice(0,start)+'\n'+input.value.slice(end);
        input.selectionStart=input.selectionEnd=start+1;
      } else {
        e.preventDefault();
        form.dispatchEvent(new Event('submit',{cancelable:true,bubbles:true}));
      }
    }
  });

  setKeyBtn.addEventListener('click',async()=>{await fetch('/api/set-key',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:apiKeyInput.value})});alert('Key set!');});
  vanishKeyBtn.addEventListener('click',()=>{apiKeyInput.value='';fetch('/api/vanish-key',{method:'POST'});});
  unvanishKeyBtn.addEventListener('click',async()=>{const res=await fetch('/api/unvanish-key',{method:'POST'});const data=await res.json();apiKeyInput.value=data.key;});
  toggleWebhookBtn.addEventListener('click',async()=>{webhookEnabled=!webhookEnabled;await fetch('/api/toggle-webhook',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:webhookEnabled,url:webhookURLInput.value})});alert('Webhook '+(webhookEnabled?'enabled':'disabled'));});
  genImageBtn.addEventListener('click',async()=>{const prompt=imagePromptInput.value.trim();if(!prompt) return;const res=await fetch('/api/image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});const data=await res.json();if(data.url){const img=document.createElement('img');img.src=data.url;img.style.maxWidth='100%';imageContainer.innerHTML='';imageContainer.appendChild(img);}});
});
</script>
</body>
</html>
